#!/bin/bash
set -e

# ralph-setup: One-time setup for Ralph CLI toolkit
# Creates symlinks in ~/.local/bin and config directory

# Resolve symlink to get actual script location
SCRIPT_PATH="$0"
if [ -L "$SCRIPT_PATH" ]; then
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
fi
RALPH_DIR="$(cd "$(dirname "$SCRIPT_PATH")/.." && pwd)"
BIN_DIR="$HOME/.local/bin"
CONFIG_DIR="$HOME/.ralph"

echo "Ralph CLI Setup"
echo "==============="
echo ""
echo "Ralph directory: $RALPH_DIR"
echo ""

# Create ~/.local/bin if it doesn't exist
if [ ! -d "$BIN_DIR" ]; then
    echo "Creating $BIN_DIR..."
    mkdir -p "$BIN_DIR"
fi

# Create ~/.ralph config directory
if [ ! -d "$CONFIG_DIR" ]; then
    echo "Creating $CONFIG_DIR..."
    mkdir -p "$CONFIG_DIR"
fi

# Create config file if it doesn't exist
if [ ! -f "$CONFIG_DIR/config" ]; then
    echo "Creating config file..."
    cat > "$CONFIG_DIR/config" << 'EOF'
# Ralph configuration
# Add your Figma token here:
# FIGMA_TOKEN=your-token-here
EOF
fi

# List of scripts to symlink
SCRIPTS=(
    "ralph-plan"
    "ralph-once"
    "ralph-afk"
    "ralph-init"
    "ralph-clear"
    "ralph-status"
    "ralph-setup"
    "ralph-configure-mcp"
)

echo ""
echo "Creating symlinks in $BIN_DIR..."

for script in "${SCRIPTS[@]}"; do
    source_path="$RALPH_DIR/bin/$script"
    link_path="$BIN_DIR/$script"

    if [ -L "$link_path" ]; then
        echo "  Updating: $script"
        rm "$link_path"
    elif [ -e "$link_path" ]; then
        echo "  Warning: $link_path exists and is not a symlink, skipping"
        continue
    else
        echo "  Creating: $script"
    fi

    ln -s "$source_path" "$link_path"
done

echo ""
echo "Setup complete!"
echo ""

# Check if ~/.local/bin is in PATH
if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
    echo "Note: $BIN_DIR is not in your PATH."
    echo "Add this to your shell profile (~/.bashrc, ~/.zshrc, etc.):"
    echo ""
    echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
    echo ""
fi

# Prompt for Figma token
echo "Would you like to configure your Figma token now? (y/n)"
read -r response
if [[ "$response" =~ ^[Yy]$ ]]; then
    echo "Enter your Figma personal access token:"
    read -r token
    if [ -n "$token" ]; then
        echo "FIGMA_TOKEN=$token" >> "$CONFIG_DIR/config"
        echo "Figma token saved to $CONFIG_DIR/config"
    fi
fi

echo ""
echo "Next steps:"
echo "  1. Run 'ralph-configure-mcp' to set up Figma MCP in Docker sandbox"
echo "  2. Navigate to your project directory"
echo "  3. Run 'ralph-plan' to create your PRD"
echo ""
