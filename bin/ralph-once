#!/bin/bash

# ralph-once: Run a single task implementation locally
# Good for testing the process before going AFK

RALPH_DIR=".ralph"
PRD_FILE="$RALPH_DIR/PRD.md"
PROGRESS_FILE="$RALPH_DIR/PROGRESS.md"
TECH_PLAN_FILE="$RALPH_DIR/TECH_PLAN.md"
ACTIVE_FILE="$RALPH_DIR/ralph-active.json"

WORKSPACE="$(pwd)"
SANDBOX_NAME="local-$(basename "$WORKSPACE")"

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source the shared prompt
source "$SCRIPT_DIR/ralph-prompt"

# Check if .ralph directory exists
if [ ! -d "$RALPH_DIR" ]; then
    echo "Error: No .ralph directory found."
    echo ""
    echo "Please run 'ralph-init' first to initialize this project."
    exit 1
fi

# Initialize active file if needed
if [ ! -f "$ACTIVE_FILE" ]; then
    echo "[]" > "$ACTIVE_FILE"
fi

# Function: Add task to active list
add_active_task() {
    local description="$1"
    local entry=$(python3 -c "
import json, sys
from datetime import datetime
entry = {
    'description': sys.argv[1],
    'started': datetime.now().isoformat(),
    'pid': $$,
    'sandbox': '$SANDBOX_NAME'
}
print(json.dumps(entry))
" "$description")

    python3 -c "
import json
with open('$ACTIVE_FILE', 'r') as f:
    active = json.load(f)
active.append($entry)
with open('$ACTIVE_FILE', 'w') as f:
    json.dump(active, f, indent=2)
"
}

# Function: Remove task from active list
remove_active_task() {
    python3 -c "
import json
with open('$ACTIVE_FILE', 'r') as f:
    active = json.load(f)
active = [t for t in active if t.get('pid') != $$]
with open('$ACTIVE_FILE', 'w') as f:
    json.dump(active, f, indent=2)
"
}

# Function: Get next pending task description from markdown PRD
get_next_task() {
    python3 -c "
import re
with open('$PRD_FILE', 'r') as f:
    content = f.read()

# Find task headers (### P0-1:, ### P1-1:, etc.) - prioritized by P0 > P1 > P2 > P3
task_headers = re.findall(r'^###\s+(P\d+-\d+):\s*(.+?)$', content, re.MULTILINE)

# Sort by priority (P0 first)
for task_id, task_name in sorted(task_headers, key=lambda x: x[0]):
    # Check if task is marked complete (has âœ… or [DONE]) or blocked (has ðŸš« or BLOCKED)
    task_section = re.search(rf'###\s+{re.escape(task_id)}:.*?(?=\n###|\n---|\Z)', content, re.DOTALL)
    if task_section:
        section_text = task_section.group(0)
        # Skip completed tasks
        if 'âœ…' in section_text[:100] or '[DONE]' in section_text[:100] or '~~' in task_name:
            continue
        # Skip blocked tasks
        if 'ðŸš«' in section_text[:100] or 'BLOCKED' in section_text[:100]:
            continue
        print(f'{task_id}: {task_name.strip()[:50]}')
        break
"
}

# Function: Update status to In Progress if currently Not Started
update_status_to_in_progress() {
    if [ -f "$PROGRESS_FILE" ]; then
        if grep -q "^## Status: ðŸ”´ Not Started" "$PROGRESS_FILE"; then
            sed -i '' 's/^## Status: ðŸ”´ Not Started/## Status: ðŸŸ¡ In Progress/' "$PROGRESS_FILE"
            echo "Status updated to ðŸŸ¡ In Progress"
        fi
    fi
}

# Clean up on exit (remove active task)
trap remove_active_task EXIT

# Update status before starting work
update_status_to_in_progress

# Track the current task as active
CURRENT_TASK=$(get_next_task)
add_active_task "$CURRENT_TASK"

# Build file list for claude
FILES_TO_READ="$PRD_FILE $PROGRESS_FILE"
if [ -f "$TECH_PLAN_FILE" ]; then
    FILES_TO_READ="$FILES_TO_READ $TECH_PLAN_FILE"
fi

claude --permission-mode acceptEdits "$FILES_TO_READ
$RALPH_TASK_PROMPT"

# Remove active task after completion
remove_active_task
