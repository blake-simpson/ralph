#!/bin/bash

# ralph-once: Run a single task implementation locally
# Good for testing the process before going AFK

PRD_DIR="$HOME/.local/ralph"
PRD_FILE="$PRD_DIR/PRD.md"
PROGRESS_FILE="$PRD_DIR/PROGRESS.md"
TECH_PLAN_FILE="$PRD_DIR/TECH_PLAN.md"

# Active task tracking
ACTIVE_FILE="$HOME/.local/ralph/ralph-active.json"
WORKSPACE="$(pwd)"
SANDBOX_NAME="local-$(basename "$WORKSPACE")"

# Ensure directory exists and initialize active file if needed
mkdir -p "$PRD_DIR"
if [ ! -f "$ACTIVE_FILE" ]; then
    echo "[]" > "$ACTIVE_FILE"
fi

# Function: Add task to active list
add_active_task() {
    local description="$1"
    local entry=$(python3 -c "
import json, sys
from datetime import datetime
entry = {
    'description': sys.argv[1],
    'started': datetime.now().isoformat(),
    'pid': $$,
    'sandbox': '$SANDBOX_NAME'
}
print(json.dumps(entry))
" "$description")

    python3 -c "
import json
with open('$ACTIVE_FILE', 'r') as f:
    active = json.load(f)
active.append($entry)
with open('$ACTIVE_FILE', 'w') as f:
    json.dump(active, f, indent=2)
"
}

# Function: Remove task from active list
remove_active_task() {
    python3 -c "
import json
with open('$ACTIVE_FILE', 'r') as f:
    active = json.load(f)
active = [t for t in active if t.get('pid') != $$]
with open('$ACTIVE_FILE', 'w') as f:
    json.dump(active, f, indent=2)
"
}

# Function: Get next pending task description from markdown PRD
get_next_task() {
    python3 -c "
import re
with open('$PRD_FILE', 'r') as f:
    content = f.read()

# Find task headers (### P0-1:, ### P1-1:, etc.) - prioritized by P0 > P1 > P2 > P3
task_headers = re.findall(r'^###\s+(P\d+-\d+):\s*(.+?)$', content, re.MULTILINE)

# Sort by priority (P0 first)
for task_id, task_name in sorted(task_headers, key=lambda x: x[0]):
    # Check if task is marked complete (has âœ… or [DONE]) or blocked (has ðŸš« or BLOCKED)
    task_section = re.search(rf'###\s+{re.escape(task_id)}:.*?(?=\n###|\n---|\Z)', content, re.DOTALL)
    if task_section:
        section_text = task_section.group(0)
        # Skip completed tasks
        if 'âœ…' in section_text[:100] or '[DONE]' in section_text[:100] or '~~' in task_name:
            continue
        # Skip blocked tasks
        if 'ðŸš«' in section_text[:100] or 'BLOCKED' in section_text[:100]:
            continue
        print(f'{task_id}: {task_name.strip()[:50]}')
        break
"
}

# Function: Update status to In Progress if currently Not Started
update_status_to_in_progress() {
    if [ -f "$PROGRESS_FILE" ]; then
        if grep -q "^## Status: ðŸ”´ Not Started" "$PROGRESS_FILE"; then
            sed -i '' 's/^## Status: ðŸ”´ Not Started/## Status: ðŸŸ¡ In Progress/' "$PROGRESS_FILE"
            echo "Status updated to ðŸŸ¡ In Progress"
        fi
    fi
}

# Clean up on exit (remove active task)
trap remove_active_task EXIT

# Update status before starting work
update_status_to_in_progress

# Track the current task as active
CURRENT_TASK=$(get_next_task)
add_active_task "$CURRENT_TASK"

# Build file list for claude
FILES_TO_READ="$PRD_FILE $PROGRESS_FILE"
if [ -f "$TECH_PLAN_FILE" ]; then
    FILES_TO_READ="$FILES_TO_READ $TECH_PLAN_FILE"
fi

claude --permission-mode acceptEdits "$FILES_TO_READ \
1. Find the highest-priority incomplete task from the Technical Tasks section (tasks are headers like ### P0-1:, ### P1-1:, etc. - P0 is highest priority). \
2. A task is incomplete if it does NOT have âœ… or [DONE] in its header. Skip tasks marked with ðŸš« BLOCKED. \
3. Read the PRD and TECH_PLAN.md (if provided). The tech plan contains architecture decisions, code patterns, and implementation guidelines you MUST follow. \
4. Load skills, load all Figma designs, and create a dedicated implementation plan including pixel perfect design. \
5. Implement the task following the implementation plan and tech plan guidelines exactly. \
6. Run your type checks and validate (npm run lint:fix, tsc, npm run test, npm run build, etc.). Fix any problems now. \
7. Commit your changes without co-authoring. \
8. Update PRD.md marking the completed task header with âœ… (e.g., '### P0-1: Task Name âœ…'). \

ONLY WORK ON A SINGLE TASK! \

=== ESCAPE HATCH === \
PRINCIPLE: Never guess when the cost of being wrong is high. If you lack information critical to the task, stop and block rather than guess. \
HARD RULE: If Figma design URLs are specified, the design MUST load successfully. Do not proceed without loading the Figma design. \
FOR OTHER SITUATIONS: Ask yourself - Am I guessing at something critical? Would significant work be wasted if I'm wrong? \
When you decide to block: Mark the task header as '### P0-X: Task Name ðŸš« BLOCKED' in the PRD. \
Update PROGRESS.md status to '## Status: ðŸ”´ BLOCKED: [reason]' and add blocker details to Blockers section."

# Remove active task after completion
remove_active_task
