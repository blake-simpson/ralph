#!/bin/bash

# ralph-prompt: Shared prompt template for ralph-once and ralph-afk
# This file is sourced by other scripts, not run directly.

RALPH_TASK_PROMPT='If any task is blocked, stop and report to the user you cannot continue. No tasks can be worked on if any are blocked.
1. Find the highest-priority incomplete task from the Technical Tasks section (tasks are headers like ### P0-2-FIX:, ### P0-1:, ### P1-1:, etc. - P0 is highest priority, anything with FIX is critical).
2. A task is incomplete if it does NOT have âœ… or [DONE] in its header. Skip tasks marked with ðŸš« BLOCKED.
3. Launch a sub-agent to:
    - Read current task, the relevant PRD info, and TECH_PLAN.md (if provided). The tech plan contains architecture decisions, code patterns, and implementation guidelines you MUST follow.
    - Load skills, load all Figma designs, and create a dedicated implementation plan including pixel perfect design.
    - Implement the task following the implementation plan and tech plan guidelines exactly.
    - Run your type checks and validate (npm run lint:fix, tsc, etc.) and fix any issues.
    - Verify task (playwright, npm run test, npm run build, etc.). Fix any problems now.
    - At all times the sub-agent MUST consider the escape hatch protocol and report blocked if it is unable to continue.
4. Commit your changes without co-authoring.
5. Update .ralph/PRD.md and .ralph/PROGRESS.md marking the completed tasks with âœ… (e.g., '\''### P0-1: Task Name âœ…'\'').

ONLY WORK ON A SINGLE TASK!!

If you discover issues with existing code, fix them if they are still within scope.
If you discover tasks that need done that are out of scope, add the plan for them to the PRD + Progress file and mark as "FWLUP" (e.g., '\''### P0-2-FWLUP: Task Name ðŸ”µ'\'').

=== ESCAPE HATCH ===
PRINCIPLE: Never guess when the cost of being wrong is high. If you lack information critical to the task, stop and block rather than guess.
HARD RULE: If Figma design URLs are specified, the design MUST load successfully. Do not proceed without loading the Figma design.
FOR OTHER SITUATIONS: Ask yourself - Am I guessing at something critical? Would significant work be wasted if I am wrong?
When you decide to block: Mark the task header as '\''### P0-X: Task Name ðŸš« BLOCKED'\'' in the PRD.
Update .ralph/PROGRESS.md status to '\''## Status: ðŸ”´ BLOCKED: [reason]'\'' and add blocker details to Blockers section.'

# AFK loop-specific prompt (used by ralph-afk for multi-iteration runs)
RALPH_AFK_LOOP_PROMPT='
=== LOOP HANDLING ===
You are running in an automated loop. After completing your task:

If you completed the task successfully AND all tasks in the PRD are now complete (all have âœ…), output:
<promise>COMPLETE</promise>

If you are blocked and cannot proceed, output:
<promise>BLOCKED</promise>
<blocked-details>
  <task-id>[e.g., P0-5]</task-id>
  <reason-category>[brief category, e.g., figma_unavailable, missing_context]</reason-category>
  <explanation>[What went wrong and why you cannot proceed]</explanation>
  <resolution-hint>[How the user can resolve this]</resolution-hint>
</blocked-details>

These signals control the loop - COMPLETE exits successfully, BLOCKED stops for human intervention.
=== END LOOP HANDLING ==='
