#!/bin/bash

# ralph-configure-mcp: Configure Figma MCP inside Docker sandbox

CONFIG_FILE="$HOME/.ralph/config"

echo "Ralph MCP Configuration"
echo "======================="
echo ""

# Load config if it exists
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# Check for Figma token
if [ -z "$FIGMA_TOKEN" ]; then
    echo "No FIGMA_TOKEN found in config or environment."
    echo ""
    echo "You can set it by:"
    echo "  1. Adding FIGMA_TOKEN=xxx to ~/.ralph/config"
    echo "  2. Setting FIGMA_TOKEN environment variable"
    echo "  3. Running ralph-setup and entering your token"
    echo ""
    echo "Would you like to enter your Figma token now? (y/n)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        echo "Enter your Figma personal access token:"
        read -r FIGMA_TOKEN
        if [ -n "$FIGMA_TOKEN" ]; then
            mkdir -p "$HOME/.ralph"
            echo "FIGMA_TOKEN=$FIGMA_TOKEN" >> "$CONFIG_FILE"
            echo "Token saved to $CONFIG_FILE"
        else
            echo "No token entered. Exiting."
            exit 1
        fi
    else
        echo "Skipping Figma MCP configuration."
        exit 0
    fi
fi

echo "Configuring Figma MCP in Docker sandbox..."
echo ""

# Use docker sandbox run with a prompt to configure MCP
# The sandbox must already be logged in (run 'docker sandbox run claude' first and /login)
if ! docker sandbox run claude -p "Run this exact command to add the Figma MCP server:

claude mcp add figma -- npx -y figma-developer-mcp --figma-api-key=$FIGMA_TOKEN

Then verify it's configured by running: claude mcp list

Just run these commands and exit immediately. Do not do anything else." 2>&1; then
    echo ""
    echo "Failed to configure MCP. This usually means Claude is not logged in."
    echo ""
    echo "Please run an interactive session first to login:"
    echo "  docker sandbox run claude"
    echo ""
    echo "Then run '/login' inside Claude, complete authentication, and '/exit'."
    echo "After that, run 'ralph-configure-mcp' again."
    exit 1
fi

echo ""
echo "MCP configuration complete!"
echo ""
echo "Note: This configuration persists in the Docker sandbox."
echo "If you delete and recreate the sandbox, run this command again."
