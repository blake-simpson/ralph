#!/bin/bash

# ralph-configure-mcp: Configure MCP servers inside Docker sandbox

CONFIG_FILE="$HOME/.ralph/config"
WORKSPACE="$(pwd)"
SANDBOX_NAME="claude-$(basename "$WORKSPACE")"

echo "Ralph MCP Configuration"
echo "======================="
echo "Sandbox: $SANDBOX_NAME"
echo ""

# Load config if it exists
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# =====================
# Playwright MCP Setup
# =====================
echo "Configuring Playwright MCP (headless mode)..."
echo ""

# Remove existing playwright MCP config if present (ignore errors)
docker sandbox run "$SANDBOX_NAME" -- mcp remove playwright 2>/dev/null || true

# Add Playwright MCP server in headless mode
echo "Adding Playwright MCP server..."
if docker sandbox run "$SANDBOX_NAME" -- mcp add playwright -- npx -y @playwright/mcp@latest --headless 2>&1; then
    echo "Playwright MCP configured successfully!"
else
    echo ""
    echo "Warning: Failed to configure Playwright MCP."
    echo "The sandbox may need browser dependencies. You can try running:"
    echo "  docker sandbox run $SANDBOX_NAME -- npx playwright install-deps"
    echo ""
fi

echo ""

# =====================
# Figma MCP Setup
# =====================

# Check for Figma token
if [ -z "$FIGMA_TOKEN" ]; then
    echo "No FIGMA_TOKEN found in config or environment."
    echo ""
    echo "You can set it by:"
    echo "  1. Adding FIGMA_TOKEN=xxx to ~/.ralph/config"
    echo "  2. Setting FIGMA_TOKEN environment variable"
    echo "  3. Running ralph-setup and entering your token"
    echo ""
    echo "Would you like to enter your Figma token now? (y/n)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        echo "Enter your Figma personal access token:"
        read -r FIGMA_TOKEN
        if [ -n "$FIGMA_TOKEN" ]; then
            mkdir -p "$HOME/.ralph"
            echo "FIGMA_TOKEN=$FIGMA_TOKEN" >> "$CONFIG_FILE"
            echo "Token saved to $CONFIG_FILE"
        else
            echo "No token entered. Exiting."
            exit 1
        fi
    else
        echo "Skipping Figma MCP configuration."
        exit 0
    fi
fi

echo "Configuring Figma MCP in Docker sandbox..."
echo ""

# Remove existing figma MCP config if present (ignore errors)
echo "Removing any existing Figma MCP configuration..."
docker sandbox run "$SANDBOX_NAME" -- mcp remove figma 2>/dev/null || true

# Add the Figma MCP server directly via CLI (not prompting Claude)
# Use PORT=3334 to avoid conflict with Docker sandbox which uses port 3333
echo "Adding Figma MCP server..."
if ! docker sandbox run "$SANDBOX_NAME" -- mcp add figma -e PORT=3334 -- npx -y figma-developer-mcp --figma-api-key="$FIGMA_TOKEN" --stdio 2>&1; then
    echo ""
    echo "Failed to configure MCP. This usually means Claude is not logged in."
    echo ""
    echo "Please run an interactive session first to login:"
    echo "  docker sandbox run $SANDBOX_NAME"
    echo ""
    echo "Then run '/login' inside Claude, complete authentication, and '/exit'."
    echo "After that, run 'ralph-configure-mcp' again."
    exit 1
fi

# Verify configuration
echo ""
echo "Verifying MCP configuration..."
docker sandbox run "$SANDBOX_NAME" -- mcp list 2>&1

echo ""
echo "MCP configuration complete!"
echo ""
echo "Configured servers:"
echo "  - Playwright (headless browser automation)"
echo "  - Figma (design file access, if token provided)"
echo ""
echo "Note: This configuration persists in the Docker sandbox."
echo "If you delete and recreate the sandbox, run this command again."
echo ""
echo "Note: Figma MCP is configured to use port 3334 to avoid conflict"
echo "with Docker sandbox infrastructure which uses port 3333."
