#!/bin/bash

# ralph-plan: Interactive planning session with Claude
# Runs LOCALLY (not in sandbox) for interactive PRD creation

RALPH_DIR=".ralph"
PRD_FILE="$RALPH_DIR/PRD.md"
PROGRESS_FILE="$RALPH_DIR/PROGRESS.md"
TECH_PLAN_FILE="$RALPH_DIR/TECH_PLAN.md"

# Check if .ralph directory exists
if [ ! -d "$RALPH_DIR" ]; then
    echo "Error: No .ralph directory found."
    echo ""
    echo "Please run 'ralph-init' first to initialize this project."
    exit 1
fi

claude --allowedTools "Write,Read,Glob,Grep,LS,mcp__figma,mcp_atlasian,WebFetch" --disallowedTools "Bash,Edit,StrReplace" -- "$PRD_FILE $PROGRESS_FILE $TECH_PLAN_FILE \
We are about to plan a set of technical features. \
I will give you the input of what the tasks are. \
Ask me as many questions as needed to clarify the approach as you plan. Continue to iteratively ask questions and refine until you are 100% concrete on your solution. Ensure all edge cases etc. are considered. Consider the product domain.  \
Perform deep research on topics that are not clear to you. \

Load the frontend-design skill, vercel-react-best-practises skill, and security skill now for planning the implementation. Also write in the plan that each agent should load these skills too when it implementes the solution. \

You must always append accepted plan as small individual tasks to the PRD.md file. Each task contains steps to complete it. \
Detect blockers/dependencies on tasks and ensure blockers are addressed first in the plan. \

Each item must involve steps checking the results (at minimum linting / tsc / npm test). \

If Figma design URLs are included, you will need to add the exact Figma URLs to the PRD so that future agents know which nodes these refer too. \

Always consider that the follow up implementation agent will only have the PRD + progress as context. It is critical that agents gets every piece of information it needs. \
 
PRDs should follow this structure: \
 
\`\`\`markdown \
# PRD: [Feature Name] \
 
## Overview \
[1-2 sentence description] \
 
## Problem Statement \
[What problem does this solve?] \
 
## Success Criteria (Definition of Done) \
- [ ] Criterion 1 \
- [ ] Criterion 2 \
- [ ] Criterion 3 \ 
 
## Acceptance Criteria (BDD) \
 
### Scenario: [Scenario Name] \
Given [context] \ 
And [more context] \ 
When [action] \ 
Then [expected result] \ 
And [additional assertions] \ 
 
## Technical Approach \ 
[High-level implementation strategy] \ 
 
## Out of Scope \ 
[What this feature explicitly does NOT include] \ 
 
## Open Questions \ 
[Questions that need answers before implementation] \ 
 
## Clarifications \ 
[Answers to open questions, added during Phase 1] \ 

## Technical Tasks \ 
[List of technical tasks that need to be completed before the feature can be implemented. Add all context needed for follow up agents (Figma URLs, API endpoints, edge cases, conflicts, etc.)] \ 
\`\`\` \

Progress files (PROGRESS.md) should follow this structure: \
 
\`\`\`markdown \
# Progress: [Feature Name] \
 
## Status: [ðŸ”´ Not Started | ðŸŸ¡ In Progress | âœ… Complete] \
 
## PRD Reference \
.ralph/PRD.md \
 
## Milestones \
 
### â¬œ M1: [Milestone Name] \
- [ ] Task 1 \
- [ ] Task 2 \
 
### â¬œ M2: [Milestone Name] \
- [ ] Task 1 \
 
## Definition of Done Checklist \
- [ ] DoD Item 1 \  
- [ ] DoD Item 2 \  

## Session History \
| Session | Date | Context Used | Milestones Completed | \
|---------|------|--------------|---------------------| \
 
## Decisions Log \    
[Numbered list of key decisions with rationale] \    
 
## Blockers \
[Any blocking issues] \    
\`\`\` \

We are in plan mode so that I can provide you the tasks to plan. Please await my input. \
After we have finished planning you should write the PRD.md file and exit. We DO NOT want to implement the plan now.
"
