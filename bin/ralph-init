#!/bin/bash
set -e

# ralph-init: Initialize Docker sandbox and local .ralph directory for this project
# Run once per project before using ralph-afk

WORKSPACE="$(pwd)"
SANDBOX_NAME="claude-$(basename "$WORKSPACE")"
RALPH_DIR=".ralph"

# Find where ralph is installed (resolve symlinks to find actual location)
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    # Handle relative symlinks
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
RALPH_INSTALL_DIR="$(dirname "$SCRIPT_DIR")"
RALPH_AGENTS_DIR="$RALPH_INSTALL_DIR/.agents"

echo "Initializing Ralph for: $WORKSPACE"
echo "Sandbox name: $SANDBOX_NAME"
echo ""

# --- Step 1: Create .ralph directory with empty state files ---
if [ -d "$RALPH_DIR" ]; then
    echo "Directory '$RALPH_DIR' already exists."
    read -p "Clear and reinitialize? [y/N] " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$RALPH_DIR"
    else
        echo "Keeping existing .ralph directory."
    fi
fi

if [ ! -d "$RALPH_DIR" ]; then
    echo "Creating .ralph directory..."
    mkdir -p "$RALPH_DIR"
    
    # Create empty PRD.md
    cat > "$RALPH_DIR/PRD.md" << 'EOF'
Inform the user to run 'ralph-plan' to create a plan for the feature.
EOF

    # Create empty PROGRESS.md
    cat > "$RALPH_DIR/PROGRESS.md" << 'EOF'
# Progress: [Feature Name]
EOF

    # Create empty active tasks file
    echo "[]" > "$RALPH_DIR/ralph-active.json"
    
    echo "  Created: $RALPH_DIR/PRD.md"
    echo "  Created: $RALPH_DIR/PROGRESS.md"
    echo "  Created: $RALPH_DIR/ralph-active.json"
fi

# --- Step 2: Add .ralph to .gitignore if needed ---
GITIGNORE=".gitignore"

if [ -f "$GITIGNORE" ]; then
    if grep -q "^\.ralph/?$" "$GITIGNORE" || grep -q "^\.ralph$" "$GITIGNORE"; then
        echo ""
        echo ".ralph is already in .gitignore"
    else
        echo ""
        read -p "Add .ralph to .gitignore? [Y/n] " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            echo "" >> "$GITIGNORE"
            echo "# Ralph local state" >> "$GITIGNORE"
            echo ".ralph/" >> "$GITIGNORE"
            echo "Added .ralph/ to .gitignore"
        fi
    fi
else
    echo ""
    read -p "Create .gitignore with .ralph entry? [Y/n] " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        echo "# Ralph local state" > "$GITIGNORE"
        echo ".ralph/" >> "$GITIGNORE"
        echo "Created .gitignore with .ralph/ entry"
    fi
fi

# --- Step 3: Install Ralph agents to project ---
echo ""
echo "Install Ralph agents to this project?"
echo "  [c] Copy agents (independent copy in project)"
echo "  [s] Symlink agents (links to ralph installation)"
echo "  [n] Skip (don't install agents)"
read -p "Choice [c/s/N]: " -n 1 -r AGENT_CHOICE
echo ""

if [[ $AGENT_CHOICE =~ ^[CcSs]$ ]]; then
    # Determine target directory
    if [ -d ".agents" ]; then
        TARGET_DIR=".agents/ralph"
    else
        TARGET_DIR=".claude/agents/ralph"
    fi
    
    echo "Installing agents to: $TARGET_DIR"
    mkdir -p "$TARGET_DIR"
    
    if [[ $AGENT_CHOICE =~ ^[Cc]$ ]]; then
        # Copy agents
        for agent in "$RALPH_AGENTS_DIR"/ralph-*.md; do
            if [ -f "$agent" ]; then
                cp "$agent" "$TARGET_DIR/"
                echo "  Copied: $(basename "$agent")"
            fi
        done
        echo "Agents copied to $TARGET_DIR"
    else
        # Symlink agents
        for agent in "$RALPH_AGENTS_DIR"/ralph-*.md; do
            if [ -f "$agent" ]; then
                agent_name="$(basename "$agent")"
                # Remove existing symlink/file if present
                rm -f "$TARGET_DIR/$agent_name"
                ln -s "$agent" "$TARGET_DIR/$agent_name"
                echo "  Linked: $agent_name"
            fi
        done
        echo "Agents symlinked to $TARGET_DIR"
    fi
else
    echo "Skipping agent installation."
fi

# --- Step 4: Create Docker sandbox ---
echo ""
if docker sandbox ls 2>/dev/null | grep -q "^$SANDBOX_NAME "; then
    echo "Sandbox '$SANDBOX_NAME' already exists."
    echo "Run 'docker sandbox rm $SANDBOX_NAME' to recreate it."
else
    echo "Creating sandbox and starting Claude..."
    echo "Please run /login when Claude starts, then exit."
    echo ""
    docker sandbox run claude "$WORKSPACE"
fi

echo ""
echo "Ralph initialized! You can now use:"
echo "  ralph-plan      - Create/update PRD interactively"
echo "  ralph-tech-plan - Create technical implementation plan"
echo "  ralph-once      - Run a single task locally"
echo "  ralph-afk <n>   - Run n tasks in docker sandbox"
echo "  ralph-status    - View progress"
echo "  ralph-clear     - Reset .ralph for fresh start"
